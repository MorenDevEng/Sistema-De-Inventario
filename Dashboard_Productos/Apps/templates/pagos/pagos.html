{% extends 'index.html' %}

{% load static %}
{% load filtros_matematicos %}

<title>{% block title %}Pagos{% endblock %}</title>
{% block pagos %}

<!-- Contenido de la página -->
<div class="py-4">
    <div class="container mx-auto px-4">
        <!-- Breadcrumb -->
        <nav class="flex mb-6" aria-label="Breadcrumb" class="flex items-center">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/home" class="text-gray-50 hover:text-primary text-sm font-medium">
                        <i class="fas fa-home mr-2"></i>
                        Dashboard
                    </a>
                </li>
                <li aria-current="page" class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="/pagos" class="flex items-center">
                        <span class="text-primary font-medium text-sm hover:dark:text-white">Pagos</span>
                    </a>
                </li>
            </ol>
        </nav>

        <!-- Título y barra de herramientas -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Gestión de Pagos</h1>

            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                    <!-- Buscador -->
                    <div class="relative">
                        <form id="form_busqueda_pago" action="{% url 'buscador_de_pago' %}">
                            
                            <div class="flex">
                                <input id="dato" name="dato" type="text" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-300 rounded-l-lg pl-10 pr-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:text-white dark:placeholder-gray-400" placeholder="Buscar pago...">
                                <button type="submit" class="bg-primary hover:bg-blue-600 text-white font-medium px-4 rounded-r-lg flex items-center justify-center ml-0">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </form>
                    </div>

                <!-- Botón Registrar Venta -->
                <button id="openPagosForm" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center whitespace-nowrap shadow-sm">
                    <i class="fas fa-plus mr-2"></i>
                    Registrar Pago
                </button>
            </div>
        </div>

        <!-- Tabla de Pagos -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                ID-Pago
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Cliente
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden md:table-cell">
                                Teléfono
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Venta
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden lg:table-cell">
                                Total $
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden lg:table-cell">
                                Monto
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden sm:table-cell">
                                Fecha
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Body
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden md:table-cell">
                                Referencia Bancaria
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                        <!-- Abonos registrados -->
                        {% for pago in pagos %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white factura">{{ pago.numero_factura }}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% with user=pago.cliente.nombre|add:' '|add:pago.cliente.apellido%}
                                        <div class="flex items-center">
                                            <div class="text-sm text-gray-900 dark:text-white factura">{{ user }}</div>
                                        </div>
                                    {% endwith %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm text-gray-900 dark:text-white factura">{{ pago.cliente.telefono }}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-white factura">
                                        {% for pv in pago.pago_unico.all %}
                                            #{{ pv.venta.id }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}
                                            <span class="text-gray-400">Sin ventas</span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm text-gray-900 dark:text-white factura">
                                            <i class="fas fa-dollar-sign text-success"></i>
                                            {{ pago.monto_dolar }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm text-gray-900 dark:text-white factura">
                                            <span class="font-bold">Bs.</span>
                                            {{ pago.monto_total|floatformat:"2g" }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm text-gray-900 dark:text-white factura">
                                            {{ pago.fecha|date:"d-m-Y H:i" }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm text-gray-900 dark:text-white factura">
                                            {{ pago.body }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm text-gray-900 dark:text-white factura">
                                            {{ pago.referencia }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button class="text-primary hover:text-blue-700 mr-3 boton-editar">
                                        <i class="hidden fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% include 'paginaciones/paginacion_pagos.html' %}
        </div>
    </div>
</div>


<!-- Formulario de Pago Parcial (Modal) -->
<div id="PagoParcialModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl md:w-2/3 lg:w-1/3 max-w-3x1 max-h-screen overflow-y-auto">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800" id="form-title">Registrar Pago Parcial</h3>
        </div>
        
        <form id="formPagoParcial" method="post" class="px-6 py-4" action="{% url 'crear_pago' %}">
            {% csrf_token %}

            <!-- Selección de cliente con dropdown personalizado -->
            <div class="mb-4 grid grid-cols-2 gap-4">
                <div class="bloque-clientes">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <div class="flex items-center relative">
                        <button id="dropdownClienteBtn" type="button"
                            class="w-64 px-3 py-2 border border-gray-300 rounded-md bg-white text-left focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent hover:border-primary flex justify-between items-center">
                            <span id="dropdownClienteLabel">Seleccione un cliente...</span>
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <!-- Menu desplegable -->
                        <div id="dropdownClienteMenu" class="w-64 mt-1 absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-10 hidden max-h-48 overflow-y-auto [scrollbar-width:none]">
                            <div class="py-1">
                                {% for cliente in clientes_deudores %}
                                    {% with user=cliente.nombre|add:' '|add:cliente.apellido %}
                                    <button type="button"
                                        class="w-full text-left px-4 py-2 hover:bg-blue-100 text-gray-700 text-sm"
                                        data-id="{{ cliente.id }}">
                                        {{ user }}
                                    </button>
                                    {% endwith %}
                                {% endfor %}

                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="cliente" name="cliente">
                    <p class="mt-1 text-xs text-danger">Este campo es requerido</p>
                </div>
                
                <div class="bloque-ventas">
                    <!-- Selección de venta pendiente (se muestra después de seleccionar cliente) -->

                    <label class="block text-sm font-medium text-gray-700 mb-1">Venta</label>
                    <div class="flex items-center relative">
                        <button id="dropdownVentaBtn" type="button"
                            class="w-64 px-3 py-2 border border-gray-300 rounded-md bg-white text-left focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent hover:border-primary flex justify-between items-center">
                            <span id="dropdownVentaLabel">Seleccione una venta...</span>
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <!-- Menu desplegable -->
                        <div id="dropdownVentaMenu" class="w-64 mt-1 absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-10 max-h-48 overflow-y-auto hidden [scrollbar-width:none]">
                            <div class="py-1 hidden" >
                                {% for venta in ventas %}
                                    <button type="button"
                                        class="hidden ventas-items w-full text-left px-4 py-2 hover:bg-blue-100 text-gray-700 text-sm"
                                        data-cliente-id="{{ venta.cliente.id }}"
                                        data-cliente-estado="{{ venta.estado }}"
                                        data-venta-id="{{ venta.id }}">
                                        Venta #{{ venta.id }} - Total: {{ venta.total_pagar }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="venta_pagar" name="venta_pagar[]" value="">
                    <p class="mt-1 text-xs text-danger">Este campo es requerido</p>
                </div>
            </div>

            <!-- Espacio para mostrar productos de la venta seleccionada -->
            <div class="mb-4 " id="productosSection">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Productos de la Venta</label>
                <!-- Productos se muestran aquí dinámicamente -->
                <div id="productosLista" class="flex space-x-1 border border-gray-300 rounded-md p-3 bg-gray-50 max-h-32 py-6 overflow-y-auto">
                {% for detalles_venta in detalles %}
                    <div class="hidden muestra-productos" 
                    data-detalles-venta="{{ detalles_venta.venta.id }}">{{ detalles_venta.producto.nombre_producto }}</div>
                {% endfor %}
                </div>
            </div>

            <!-- Selección de porcentaje de pago -->
            <div class="mb-4 grid grid-cols-2 gap-4">
                <div class="bloque-pagos-porcentaje">
                    <label for="porcentajePago" class="block text-sm font-semibold text-gray-700 mb-1">Porcentaje de Pago</label>
                    <select id="porcentajePago" name="porcentaje" class="w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" disabled>
                        <option value="">Seleccione un porcentaje...</option>
                        <option value="50">50%</option>
                        <option value="100">100%</option>
                    </select>
                    <p class="mt-1 text-xs text-danger">Este campo es requerido</p>
                </div>

                <div class="pago-completo-ventas flex items-center h-full">
                    <!-- Seleccionar si desea pagar todas las ventas pendientes -->
                    <div class="flex items-center ps-4 bg-neutral-primary-soft border border-default rounded-md shadow-xs w-64">
                        <input id="bordered-checkbox-1" type="checkbox" value="" name="bordered-checkbox" class="w-4 h-4 border border-default-medium rounded-xs bg-neutral-secondary-medium" disabled>
                        <label for="bordered-checkbox-1" class="select-none w-full py-4 ms-2 text-sm font-medium text-heading">Pagar Todo</label>
                    </div>
                </div>
            </div>


            <!-- Campo para mostrar el monto calculado -->
            <div class="mb-4 grid grid-cols-2 gap-4">
            
                <div class="bloque-mostrar-monto">
                    <label for="montoPago" class="block text-sm font-semibold text-gray-700 mb-1">Monto a Pagar</label>
                    
                    <input type="text" id="montoPago" name="monto" readonly class="w-64 px-3 py-2 border border-gray-300 rounded-md bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Seleccione cliente y venta"/>
                    <input type="text" id="montoDolar" name="montoDolar" class="hidden">
                    <span class="monto-dolar hidden" data-dolar="{{ dolar_bcv }}"></span>
                    <p class="mt-1 text-xs text-gray-500">Se calcula automáticamente basado en el porcentaje seleccionado.</p>
                </div>

                <div class="bloque-referencia">
                    <label for="referenciaBancaria" class="block text-sm font-semibold text-gray-700 mb-1">Referencia Bancaria</label>
                    <input type="text" maxlength="6" minlength="6" id="referenciaBancaria" name="referenciaBancaria" class="w-64 px-3 py-2 border border-gray-300 rounded-md bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="597482"/>
                    <p class="mt-1 text-xs text-gray-500">Ultimos 6 digitos de referencia.</p>
                    <p class="mt-1 text-xs text-danger">Este campo es requerido</p>
                </div>

            </div>

            <!-- Calendario para editar fecha y hora del pago -->
            <input 
            type="text" 
            class="hidden w-full rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-primary"
            placeholder="YYYY-MM-DD HH:MM" 
            id="flatpickr-date-time" />

            <!-- Botones de acción -->
            <div class="flex justify-end space-x-3 border-t border-gray-200 pt-4">
                <button type="button" id="cancelFormPago" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Cancelar
                </button>
                <button class="px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Guardar Pago
                </button>
            </div>
        </form>
    </div>
</div>


{% if messages %}
    {% for message in messages %}
        <script>
            if ( '{{ message.tags }}' == 'error' ) {
            mensajeDatosIncorrectos('{{ message }}');
            } else {
            mensajeSucces('{{ message }}');
            };
        </script>
    {% endfor %}
{% endif %}


<script src="{% static 'js/accionesPagos.js' %}"></script>

{% endblock %}
